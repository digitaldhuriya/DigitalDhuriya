generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id                 String       @id @default(cuid())
  name               String
  email              String       @unique
  passwordHash       String
  role               Role         @default(FREELANCER)
  isActive           Boolean      @default(true)
  commissionPercent  Decimal?     @db.Decimal(5, 2)
  createdAt          DateTime     @default(now())
  updatedAt          DateTime     @updatedAt
  ownedLeads         Lead[]       @relation("LeadOwner")
  leadNotes          LeadNote[]
  projectMemberships ProjectMember[]
  assignedTasks      Task[]       @relation("TaskAssignee")
  createdTasks       Task[]       @relation("TaskCreator")
  uploadedFiles      ProjectFile[]
  commissions        Commission[] @relation("SalesPersonCommission")
  crmNotes           CRMNote[]
  blogPosts          BlogPost[]   @relation("BlogAuthor")
  createdInvoices    Invoice[]    @relation("InvoiceCreator")
  createdQuotations  Quotation[]  @relation("QuotationCreator")
  generatedBackups   BackupLog[]
}

enum Role {
  SUPER_ADMIN
  SALES_MANAGER
  DIGITAL_MARKETING_EXECUTIVE
  FREELANCER
  ACCOUNTANT
}

model Lead {
  id              String      @id @default(cuid())
  companyName     String
  contactName     String
  email           String?
  phone           String?
  country         String?
  source          String?
  status          LeadStatus  @default(NEW)
  estimatedValue  Decimal?    @db.Decimal(12, 2)
  assignedToId    String?
  assignedTo      User?       @relation("LeadOwner", fields: [assignedToId], references: [id], onDelete: SetNull)
  notes           String?
  createdAt       DateTime    @default(now())
  updatedAt       DateTime    @updatedAt
  convertedClient Client?
  leadNotes       LeadNote[]
  crmNotes        CRMNote[]
  quotations      Quotation[]
  commissions     Commission[]

  @@index([status])
  @@index([assignedToId])
}

enum LeadStatus {
  NEW
  CONTACTED
  PROPOSAL_SENT
  WON
  LOST
}

model LeadNote {
  id          String   @id @default(cuid())
  leadId      String
  lead        Lead     @relation(fields: [leadId], references: [id], onDelete: Cascade)
  createdById String?
  createdBy   User?    @relation(fields: [createdById], references: [id], onDelete: SetNull)
  content     String
  createdAt   DateTime @default(now())

  @@index([leadId])
}

model Client {
  id             String        @id @default(cuid())
  companyName    String
  contactName    String
  email          String?
  phone          String?
  address        String?
  city           String?
  state          String?
  country        String?
  gstNumber      String?
  contractStart  DateTime?
  contractEnd    DateTime?
  status         ClientStatus  @default(ACTIVE)
  leadId         String?       @unique
  lead           Lead?         @relation(fields: [leadId], references: [id], onDelete: SetNull)
  createdAt      DateTime      @default(now())
  updatedAt      DateTime      @updatedAt
  activeServices ClientService[]
  projects       Project[]
  quotations     Quotation[]
  invoices       Invoice[]
  crmNotes       CRMNote[]

  @@index([status])
}

enum ClientStatus {
  ACTIVE
  ONBOARDING
  ON_HOLD
  COMPLETED
  INACTIVE
}

model Service {
  id           String        @id @default(cuid())
  name         String        @unique
  description  String?
  basePrice    Decimal       @db.Decimal(12, 2)
  taxPercent   Decimal       @default(0) @db.Decimal(5, 2)
  isActive     Boolean       @default(true)
  createdAt    DateTime      @default(now())
  updatedAt    DateTime      @updatedAt
  clients      ClientService[]
  quoteItems   QuotationItem[]
  invoiceItems InvoiceItem[]
}

model ClientService {
  id           String   @id @default(cuid())
  clientId     String
  serviceId    String
  startDate    DateTime @default(now())
  endDate      DateTime?
  billingCycle String?
  agreedPrice  Decimal? @db.Decimal(12, 2)
  isActive     Boolean  @default(true)
  createdAt    DateTime @default(now())
  client       Client   @relation(fields: [clientId], references: [id], onDelete: Cascade)
  service      Service  @relation(fields: [serviceId], references: [id], onDelete: Restrict)

  @@unique([clientId, serviceId, isActive])
}

model Project {
  id          String          @id @default(cuid())
  name        String
  description String?
  clientId    String
  client      Client          @relation(fields: [clientId], references: [id], onDelete: Restrict)
  status      ProjectStatus   @default(PLANNED)
  priority    ProjectPriority @default(MEDIUM)
  startDate   DateTime?
  deadline    DateTime?
  completedAt DateTime?
  createdAt   DateTime        @default(now())
  updatedAt   DateTime        @updatedAt
  members     ProjectMember[]
  tasks       Task[]
  files       ProjectFile[]
  crmNotes    CRMNote[]
  invoices    Invoice[]

  @@index([clientId])
  @@index([status])
}

enum ProjectStatus {
  PLANNED
  IN_PROGRESS
  ON_HOLD
  COMPLETED
  CANCELLED
}

enum ProjectPriority {
  LOW
  MEDIUM
  HIGH
  CRITICAL
}

model ProjectMember {
  id          String   @id @default(cuid())
  projectId   String
  userId      String
  designation String?
  createdAt   DateTime @default(now())
  project     Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)
  user        User     @relation(fields: [userId], references: [id], onDelete: Restrict)

  @@unique([projectId, userId])
  @@index([userId])
}

model Task {
  id           String     @id @default(cuid())
  projectId     String
  project       Project    @relation(fields: [projectId], references: [id], onDelete: Cascade)
  title        String
  description  String?
  status       TaskStatus  @default(TODO)
  dueDate      DateTime?
  assignedToId String?
  assignedTo   User?       @relation("TaskAssignee", fields: [assignedToId], references: [id], onDelete: SetNull)
  createdById  String?
  createdBy    User?       @relation("TaskCreator", fields: [createdById], references: [id], onDelete: SetNull)
  createdAt    DateTime    @default(now())
  updatedAt    DateTime    @updatedAt

  @@index([projectId])
  @@index([status])
}

enum TaskStatus {
  TODO
  IN_PROGRESS
  IN_REVIEW
  DONE
  BLOCKED
}

model ProjectFile {
  id           String   @id @default(cuid())
  projectId    String
  project      Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)
  uploadedById String?
  uploadedBy   User?    @relation(fields: [uploadedById], references: [id], onDelete: SetNull)
  fileName     String
  filePath     String
  mimeType     String
  fileSize     Int
  createdAt    DateTime @default(now())

  @@index([projectId])
}

model Quotation {
  id              String          @id @default(cuid())
  quotationNumber String          @unique
  clientId        String
  leadId          String?
  createdById     String
  issueDate       DateTime        @default(now())
  validUntil      DateTime
  status          QuotationStatus @default(DRAFT)
  currency        String          @default("INR")
  gstEnabled      Boolean         @default(true)
  subtotal        Decimal         @db.Decimal(12, 2)
  taxPercent      Decimal         @db.Decimal(5, 2)
  taxAmount       Decimal         @db.Decimal(12, 2)
  total           Decimal         @db.Decimal(12, 2)
  notes           String?
  createdAt       DateTime        @default(now())
  updatedAt       DateTime        @updatedAt
  client          Client          @relation(fields: [clientId], references: [id], onDelete: Restrict)
  lead            Lead?           @relation(fields: [leadId], references: [id], onDelete: SetNull)
  createdBy       User            @relation("QuotationCreator", fields: [createdById], references: [id], onDelete: Restrict)
  items           QuotationItem[]
  invoices        Invoice[]

  @@index([clientId])
  @@index([status])
}

enum QuotationStatus {
  DRAFT
  SENT
  ACCEPTED
  REJECTED
  EXPIRED
}

model QuotationItem {
  id          String    @id @default(cuid())
  quotationId String
  serviceId   String?
  description String
  quantity    Int       @default(1)
  unitPrice   Decimal   @db.Decimal(12, 2)
  lineTotal   Decimal   @db.Decimal(12, 2)
  quotation   Quotation @relation(fields: [quotationId], references: [id], onDelete: Cascade)
  service     Service?  @relation(fields: [serviceId], references: [id], onDelete: SetNull)
}

model Invoice {
  id             String        @id @default(cuid())
  invoiceNumber  String        @unique
  clientId       String
  projectId      String?
  quotationId    String?
  createdById    String
  issueDate      DateTime      @default(now())
  dueDate        DateTime
  status         InvoiceStatus @default(DRAFT)
  paymentStatus  PaymentStatus @default(PENDING)
  currency       String        @default("INR")
  subtotal       Decimal       @db.Decimal(12, 2)
  taxPercent     Decimal       @db.Decimal(5, 2)
  taxAmount      Decimal       @db.Decimal(12, 2)
  total          Decimal       @db.Decimal(12, 2)
  amountReceived Decimal       @default(0) @db.Decimal(12, 2)
  balance        Decimal       @db.Decimal(12, 2)
  lastPaymentDate DateTime?
  notes          String?
  createdAt      DateTime      @default(now())
  updatedAt      DateTime      @updatedAt
  client         Client        @relation(fields: [clientId], references: [id], onDelete: Restrict)
  project        Project?      @relation(fields: [projectId], references: [id], onDelete: SetNull)
  quotation      Quotation?    @relation(fields: [quotationId], references: [id], onDelete: SetNull)
  createdBy      User          @relation("InvoiceCreator", fields: [createdById], references: [id], onDelete: Restrict)
  items          InvoiceItem[]
  commissions    Commission[]

  @@index([clientId])
  @@index([status])
}

enum InvoiceStatus {
  DRAFT
  SENT
  PARTIALLY_PAID
  PAID
  OVERDUE
  CANCELLED
}

enum PaymentStatus {
  PENDING
  PARTIAL
  PAID
}

model InvoiceItem {
  id          String   @id @default(cuid())
  invoiceId   String
  serviceId   String?
  description String
  quantity    Int      @default(1)
  unitPrice   Decimal  @db.Decimal(12, 2)
  lineTotal   Decimal  @db.Decimal(12, 2)
  invoice     Invoice  @relation(fields: [invoiceId], references: [id], onDelete: Cascade)
  service     Service? @relation(fields: [serviceId], references: [id], onDelete: SetNull)
}

model Commission {
  id                String           @id @default(cuid())
  salesPersonId     String
  leadId            String?
  invoiceId         String
  commissionPercent Decimal          @db.Decimal(5, 2)
  baseAmount        Decimal          @db.Decimal(12, 2)
  commissionAmount  Decimal          @db.Decimal(12, 2)
  status            CommissionStatus @default(PENDING)
  earnedAt          DateTime         @default(now())
  paidAt            DateTime?
  createdAt         DateTime         @default(now())
  salesPerson       User             @relation("SalesPersonCommission", fields: [salesPersonId], references: [id], onDelete: Restrict)
  lead              Lead?            @relation(fields: [leadId], references: [id], onDelete: SetNull)
  invoice           Invoice          @relation(fields: [invoiceId], references: [id], onDelete: Cascade)

  @@unique([invoiceId, salesPersonId])
  @@index([salesPersonId])
  @@index([status])
}

enum CommissionStatus {
  PENDING
  EARNED
  PAID
  VOID
}

model CRMNote {
  id          String      @id @default(cuid())
  noteType    CRMNoteType
  leadId      String?
  clientId    String?
  projectId   String?
  content     String
  createdById String
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt
  lead        Lead?       @relation(fields: [leadId], references: [id], onDelete: SetNull)
  client      Client?     @relation(fields: [clientId], references: [id], onDelete: SetNull)
  project     Project?    @relation(fields: [projectId], references: [id], onDelete: SetNull)
  createdBy   User        @relation(fields: [createdById], references: [id], onDelete: Restrict)
}

enum CRMNoteType {
  LEAD
  CLIENT
  PROJECT
  GENERAL
}

model BlogPost {
  id              String     @id @default(cuid())
  title           String
  slug            String     @unique
  content         String
  status          BlogStatus @default(DRAFT)
  metaTitle       String?
  metaDescription String?
  coverImage      String?
  publishedAt     DateTime?
  authorId        String
  createdAt       DateTime   @default(now())
  updatedAt       DateTime   @updatedAt
  author          User       @relation("BlogAuthor", fields: [authorId], references: [id], onDelete: Restrict)
}

enum BlogStatus {
  DRAFT
  PUBLISHED
}

model Setting {
  id                Int      @id @default(1)
  brandName         String   @default("Digital Dhuriya")
  companyName       String   @default("Digital Dhuriya")
  address           String?
  city              String?  @default("Kanpur")
  state             String?  @default("Uttar Pradesh")
  country           String?  @default("India")
  phone             String?
  email             String?
  website           String?
  gstNumber         String?
  logoUrl           String?
  smtpHost          String?
  smtpPort          Int?
  smtpUser          String?
  smtpPassEncrypted String?
  smtpFromEmail     String?
  taxPercent        Decimal  @default(18) @db.Decimal(5, 2)
  currency          String   @default("INR")
  whatsappApiUrl    String?
  whatsappApiToken  String?
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
}

model BackupLog {
  id          String   @id @default(cuid())
  fileName    String
  filePath    String
  createdById String?
  createdAt   DateTime @default(now())
  createdBy   User?    @relation(fields: [createdById], references: [id], onDelete: SetNull)
}

